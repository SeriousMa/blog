title: 微信朋友圈技术实现调研
date: 2016-01-07 14:01:42
tags: 微信 朋友圈
---
1. feed
2. comment
3. photo video url
4. timeline

## 痛点
1. 协议
2. 集群模块划分
3. 容灾
4. 数据同步
5. 网络优化
6. 灰度上线
7. 弱网环境适配

## 工作流程
### feed发送
1. 图片上传,不经过微信后台服务器,而是直接上传到最近的腾讯CDN节点,所以非常快.
2. feed发布完成后,触发批处理操作,更新好友的timeline.

### 增量拉取
客户端保存上一次请求的timeline,服务端返回当前timeline以后的发生的action id 

### 全量拉取
客户端保存的timeline时间跨度过长,服务端返回最新X条数据并且更新timeline到最后一次时间

## 灰度上线
暂无详细资料

## 实现
### 通信协议
1. 以前: XMPP 优点:简单,大量开源实现,缺点:状态初始化流量大,消息不可靠
2. 现在: SYNC协议,是参考Microsoft Exchange ActiveSync来实现的
3. 新老版本协议兼容

### 数据同步
![Quorum](/images/Quorum.png)
[Quorum](http://blog.csdn.net/turkeyzhou/article/details/9307551)三机协议:
Quorum_KV是微信开发的一套数据强一致性存储系统,主要支持key-table和key-value两种存储模型.

1. 强一致性的Quorum容灾方案,支持读写容灾,双机互备,双向可写
2. 丰富的业务开发模型 
	* 支持类SQL接口(不支持事务),提供丰富查询和更新接口 
	* 支持string-val的高性能key-val接口
	* 支持专用于存储索引的64bit有序数组接口
3. 支持多机房部署容灾,目前支持kv2和kv6两种部署模式
4. 支持自动化数据迁移扩容
5. 高性能,在string-val模式下,已到达20wqps

### 服务质量
1. 模块优先级划分,物理隔离.
2. 可扩展性.
3. 接入层优化. 移动用户连接移动的节点,海外用户ip通过服务端测速逆向寻找最优接入点.
4. 流量监控. 对每一个用户的行为做一个监控,当发现异常的时候,后台会给终端发出指令,使得微信终端在一段时间无法联网,但是可以保证用户流量不会白白的使用掉.

## 容灾
1. 功能权重 红包 点对点聊天 群组聊天 朋友圈 视频 摇一摇
2. 功能模块之间保持单独可用.敏感词服务挂了,不能影响消息发送
3. 主备容灾,双master写入,Quorum_KV数据容灾
4. 不同地区机房之间有专线连接,出问题时(上海--加拿大)切换至公网,走普通互联网通信(域名?)


## 总结
